<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legozo 3D CMS</title>
</head>
<body>
    <!-- Canvas for 3D rendering -->
    <canvas id="renderCanvas"></canvas>

    <!-- Babylon.js CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>

    <!-- Bootstrap Module Loader -->
    <script type="module">
        import { LegozoLoader } from './core/legozo-loader.js';

        // Error handlers
        window.addEventListener('error', (e) => console.error('[Legozo] Error:', e.error));
        window.addEventListener('unhandledrejection', (e) => console.error('[Legozo] Unhandled rejection:', e.reason));

        // Bootstrap function
        async function bootstrap() {
            try {
                const legozo = new LegozoLoader();
                window.legozo = legozo; // Global reference

                await legozo.init('./config/scene-demo.json');
                await legozo.start();

                // Temporary global handlers for inline onclick in templates
                setupGlobalHandlers(legozo);

            } catch (error) {
                console.error('[Legozo] Bootstrap failed:', error);
                showError(error);
            }
        }

        // Global UI handlers (temporary until fully modularized)
        function setupGlobalHandlers(legozo) {
            const engine = legozo.engine;

            // Welcome/Demo
            window.startDemo = () => {
                document.getElementById('welcomeMessage')?.classList.add('hidden');
            };

            // Mode Toggle
            window.toggleMode = () => {
                const btn = document.getElementById('modeToggleBtn');
                const controlPanel = document.querySelector('.control-panel');
                const propertiesPanel = document.querySelector('.properties-panel');

                // Toggle mode in engine/plugins
                const currentMode = engine.scene.metadata?.mode || 'edit';
                const newMode = currentMode === 'edit' ? 'view' : 'edit';

                if (engine.scene.metadata) {
                    engine.scene.metadata.mode = newMode;
                } else {
                    engine.scene.metadata = { mode: newMode };
                }

                // Emit mode:changed event to notify plugins (InteractionPlugin, etc.)
                if (engine.events) {
                    engine.events.emit('mode:changed', { mode: newMode });
                    console.log(`[Legozo] Emitted mode:changed event: ${newMode}`);
                }

                // Update UI
                if (newMode === 'view') {
                    controlPanel?.classList.add('hidden');
                    propertiesPanel?.classList.add('hidden');
                    document.body.classList.add('view-mode');
                    document.body.classList.remove('edit-mode');
                    if (btn) btn.innerHTML = '‚úèÔ∏è Switch to Edit Mode (Tab)';
                } else {
                    controlPanel?.classList.remove('hidden');
                    propertiesPanel?.classList.remove('hidden');
                    document.body.classList.add('edit-mode');
                    document.body.classList.remove('view-mode');
                    if (btn) btn.innerHTML = 'üëÅÔ∏è Switch to View Mode (Tab)';
                }

                console.log(`[Legozo] Mode switched to: ${newMode}`);
            };

            // Instructions Toggle
            window.toggleInstructions = () => {
                const instructions = document.getElementById('instructions');
                const btn = document.getElementById('toggleBtn');
                if (instructions) {
                    instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
                    btn?.classList.toggle('visible');
                }
            };

            // Ground Texture
            window.setGroundTexture = (texture) => {
                const groundPlugin = engine.plugins.get('ground');
                if (groundPlugin && groundPlugin.useTexturePreset) {
                    groundPlugin.useTexturePreset(texture);
                    console.log(`[Legozo] Ground texture preset applied: ${texture}`);
                } else {
                    console.warn('[Legozo] GroundPlugin or useTexturePreset method not found');
                }
            };

            // Texture Tiling
            window.updateTextureTiling = (value) => {
                const groundPlugin = engine.plugins.get('ground');
                if (groundPlugin && groundPlugin.setTextureTiling) {
                    const scale = parseFloat(value);
                    groundPlugin.setTextureTiling(scale, scale);
                    document.getElementById('textureTiling').textContent = `${value}x`;
                    console.log(`[Legozo] Texture tiling set to: ${value}x`);
                }
            };

            // Sky Presets
            window.setSkyPreset = (preset) => {
                const skyPlugin = engine.plugins.get('sky');
                if (skyPlugin && skyPlugin.usePreset) {
                    skyPlugin.usePreset(preset);
                    console.log(`[Legozo] Sky preset: ${preset}`);
                }
            };

            // Lighting Presets
            window.setLightingPreset = (preset) => {
                const lightingPlugin = engine.plugins.get('lighting');
                if (lightingPlugin && lightingPlugin.usePreset) {
                    lightingPlugin.usePreset(preset);
                    console.log(`[Legozo] Lighting preset: ${preset}`);
                }
            };

            // Shadow Quality
            window.setShadowQuality = (quality) => {
                const shadowPlugin = engine.plugins.get('shadow');
                if (shadowPlugin && shadowPlugin.setQuality) {
                    shadowPlugin.setQuality(quality);
                    console.log(`[Legozo] Shadow quality: ${quality}`);
                }
            };
        }

        // Show error UI
        function showError(error) {
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                     background: rgba(255,0,0,0.9); color: white; padding: 30px; border-radius: 10px;
                     font-family: monospace; max-width: 600px;">
                    <h2>‚ùå Failed to Initialize</h2>
                    <p>${error.message}</p>
                    <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow: auto;">
${error.stack}</pre>
                    <button onclick="location.reload()" style="background: white; color: #c00; border: none;
                         padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 15px;">
                        Reload Page
                    </button>
                </div>
            `;
        }

        // Auto-start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bootstrap);
        } else {
            bootstrap();
        }
    </script>
</body>
</html>
